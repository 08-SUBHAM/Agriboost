<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - AgriBoost</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#26B4FF',
                        facebook: '#3B5998',
                        instagram: '#000',
                        light: '#babbbc',
                        muted: '#4E5155',
                        borderlight: 'rgba(24, 28, 33, 0.03)'
                    },
                    boxShadow: {
                        card: '0 1px 4px rgba(24, 28, 33, 0.012)'
                    }
                }
            }
        }
    </script>
    <style>
        .account-settings-fileinput {
            position: absolute;
            visibility: hidden;
            width: 1px;
            height: 1px;
            opacity: 0;
        }
        
        .row-bordered {
            overflow: hidden;
        }
        
        .ui-w-80 {
            width: 80px !important;
            height: auto;
        }
        
        .tab-content > .tab-pane {
            display: none;
        }
        
        .tab-content > .active {
            display: block;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-md">
        <div class="mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <!-- Logo/Brand - Far Left -->
                <div class="flex-shrink-0">
                    <a href="/">
                        <img src="./images/logo.png" alt="AgriBoost Logo" class="h-10 w-auto">  
                    </a>
                </div>
                <div class="hidden md:flex space-x-8">
                    <a href="/about" class="text-gray-700 hover:text-green-600 px-3 py-2 text-sm font-medium">About Us</a>
                    <a href="/dashboard" class="text-gray-700 hover:text-green-600 px-3 py-2 text-sm font-medium">Dashboard</a>
                </div>
                
                <!-- Profile Dropdown - Far Right -->
                <div class="relative ml-4">
                    <button type="button" class="flex items-center text-gray-700 hover:text-green-600 focus:outline-none" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                        <span class="sr-only">Open user menu</span>
                        <% if (user && user.profilePicture && user.profilePicture.data) { %>
                            <img src="data:<%= user.profilePicture.contentType %>;base64,<%= user.profilePicture.data.toString('base64') %>" 
                                 alt="Profile Picture" 
                                 class="h-8 w-8 rounded-full object-cover">
                        <% } else { %>
                            <div class="h-8 w-8 rounded-full bg-purple-100 flex items-center justify-center text-sm font-bold text-purple-600">
                                <%= user.firstname.charAt(0).toUpperCase() %><%= user.surname.charAt(0).toUpperCase() %>
                            </div>
                        <% } %>
                    </button>
                    
                    <!-- Dropdown Menu (hidden by default) -->
                    <div class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10" id="user-menu">
                        <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profile</a>
                        <a href="/dashboard" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Dashboard</a>
                        <a href="/logout" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <% if (!user) { %>
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            User data not available. Please login again.
        </div>
    <% } else { %>
    <div class="container mx-auto px-4 py-8">
        <h4 class="font-bold text-xl py-3 mb-4">
            Account settings
        </h4>
        
        <% if (typeof error !== 'undefined' && error) { %>
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <span class="block sm:inline"><%= error %></span>
            </div>
        <% } %>
        
        <% if (typeof success !== 'undefined' && success) { %>
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                <span class="block sm:inline"><%= success %></span>
            </div>
        <% } %>

        <form method="post" action="/profile" enctype="multipart/form-data">
            <input type="hidden" name="activeTab" id="activeTabField" value="<%= activeTab || 'general' %>">
            
            <div class="bg-white rounded-lg shadow-card overflow-hidden">
                <div class="row-bordered flex flex-col md:flex-row border-gray-200">
                    <div class="w-full md:w-1/4 pt-0">
                        <div class="border-r border-gray-200">
                            <a class="block py-3 px-6 border-b border-gray-100 bg-transparent font-medium text-gray-700 tab-link <%= activeTab === 'general' ? 'active' : '' %> cursor-pointer" data-target="#account-general">General</a>
                            <a class="block py-3 px-6 border-b border-gray-100 text-gray-600 hover:text-gray-800 tab-link <%= activeTab === 'change-password' ? 'active' : '' %> cursor-pointer" data-target="#account-change-password">Change password</a>
                            <a class="block py-3 px-6 border-b border-gray-100 text-gray-600 hover:text-gray-800 tab-link <%= activeTab === 'info' ? 'active' : '' %> cursor-pointer" data-target="#account-info">Info</a>
                            <a class="block py-3 px-6 border-b border-gray-100 text-gray-600 hover:text-gray-800 tab-link <%= activeTab === 'social-links' ? 'active' : '' %> cursor-pointer" data-target="#account-social-links">Social links</a>
                            <a class="block py-3 px-6 border-b border-gray-100 text-gray-600 hover:text-gray-800 tab-link <%= activeTab === 'notifications' ? 'active' : '' %> cursor-pointer" data-target="#account-notifications">Notifications</a>
                        </div>
                    </div>
                    <div class="w-full md:w-3/4">
                        <div class="tab-content">
                            <!-- General Tab -->
                            <div class="tab-pane <%= activeTab === 'general' ? 'active' : '' %>" id="account-general">
                                <div class="p-6 flex items-center">
                                    <% if (user.profilePicture && user.profilePicture.data) { %>
                                        <img src="data:<%= user.profilePicture.contentType %>;base64,<%= user.profilePicture.data.toString('base64') %>" 
                                             alt="Profile Picture" class="ui-w-80 rounded-full">
                                    <% } else { %>
                                        <div class="h-8 w-8 rounded-full bg-purple-100 flex items-center justify-center text-sm font-bold text-purple-600">
                                            <%= user.firstname.charAt(0).toUpperCase() %><%= user.surname.charAt(0).toUpperCase() %>
                                        </div>
                                    <% } %>
                                    <div class="ml-4">
                                        <label class="inline-flex items-center px-4 py-2 border border-primary rounded-md text-primary cursor-pointer hover:bg-blue-50">
                                            Upload new photo
                                            <input type="file" name="profilePicture" class="account-settings-fileinput" accept="image/*">
                                        </label>
                                        <button type="button" class="ml-2 px-4 py-2 border border-gray-200 rounded-md text-gray-600 hover:bg-gray-50">Reset</button>
                                        <div class="text-light text-sm mt-1">Allowed JPG, GIF or PNG. Max size of 800K</div>
                                    </div>
                                </div>
                                <hr class="border-gray-200 m-0">
                                <div class="p-6">
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">First Name</label>
                                        <input type="text" name="firstname" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="<%= user.firstname || '' %>">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">Surname</label>
                                        <input type="text" name="surname" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="<%= user.surname || '' %>">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">E-mail</label>
                                        <input type="text" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md mb-1" value="<%= user.email || '' %>">
                                        <% if (!user.emailVerified) { %>
                                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mt-3">
                                                <div class="text-yellow-700">
                                                    <p>Your email is not confirmed. Please check your inbox.<br>
                                                        <a href="javascript:void(0)" class="text-yellow-700 underline">Resend confirmation</a>
                                                    </p>
                                                </div>
                                            </div>
                                        <% } %>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">Company</label>
                                        <input type="text" name="company" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="<%= user.company || '' %>">
                                    </div>
                                </div>
                            </div>

                            <!-- Change Password Tab -->
                            <div class="tab-pane <%= activeTab === 'change-password' ? 'active' : '' %>" id="account-change-password">
                                <div class="p-6 pb-2">
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">Current password</label>
                                        <input type="password" name="currentPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">New password</label>
                                        <input type="password" name="newPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">Repeat new password</label>
                                        <input type="password" name="confirmPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                </div>
                            </div>

                            <!-- Info Tab -->
                            <div class="tab-pane <%= activeTab === 'info' ? 'active' : '' %>" id="account-info">
                                <div class="p-6 pb-2">
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">Bio</label>
                                        <textarea name="bio" class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="5"><%= user.bio || '' %></textarea>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">Birthday</label>
                                        <input type="date" name="birthday" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="<%= user.birthday ? new Date(user.birthday).toISOString().split('T')[0] : '' %>">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">Country</label>
                                        <select name="country" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white">
                                            <option value="USA" <%= user.country === 'USA' ? 'selected' : '' %>>USA</option>
                                            <option value="Canada" <%= user.country === 'Canada' ? 'selected' : '' %>>Canada</option>
                                            <option value="UK" <%= user.country === 'UK' ? 'selected' : '' %>>UK</option>
                                            <option value="Germany" <%= user.country === 'Germany' ? 'selected' : '' %>>Germany</option>
                                            <option value="France" <%= user.country === 'France' ? 'selected' : '' %>>France</option>
                                        </select>
                                    </div>
                                </div>
                                <hr class="border-gray-200 m-0">
                                <div class="p-6 pb-2">
                                    <h6 class="mb-4 font-medium">Contacts</h6>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">Phone</label>
                                        <input type="text" name="phone" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="<%= user.phone || '' %>">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">Website</label>
                                        <input type="url" name="website" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="<%= user.website || '' %>">
                                    </div>
                                </div>
                            </div>

                            <!-- Social Links Tab -->
                            <div class="tab-pane <%= activeTab === 'social-links' ? 'active' : '' %>" id="account-social-links">
                                <div class="p-6 pb-2">
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">Twitter</label>
                                        <input type="url" name="twitter" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="<%= user.socialLinks && user.socialLinks.twitter || '' %>">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">Facebook</label>
                                        <input type="url" name="facebook" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="<%= user.socialLinks?.facebook || '' %>">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">Instagram</label>
                                        <input type="url" name="instagram" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="<%= user.socialLinks?.instagram || '' %>">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-1">LinkedIn</label>
                                        <input type="url" name="linkedin" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="<%= user.socialLinks?.linkedin || '' %>">
                                    </div>
                                </div>
                            </div>

                            <!-- Notifications Tab -->
                            <div class="tab-pane <%= activeTab === 'notifications' ? 'active' : '' %>" id="account-notifications">
                                <div class="p-6 pb-2">
                                    <h6 class="mb-4 font-medium">Activity</h6>
                                    <div class="mb-4 flex items-center">
                                        <input type="checkbox" name="articleComments" class="form-checkbox h-5 w-5 text-blue-600" <%= user.notifications && user.notifications.articleComments ? 'checked' : '' %>>
                                        <span class="ml-2">Email me when someone comments on my article</span>
                                    </div>
                                    <div class="mb-4 flex items-center">
                                        <input type="checkbox" name="forumAnswers" class="form-checkbox h-5 w-5 text-blue-600" <%= user.notifications?.forumAnswers ? 'checked' : '' %>>
                                        <span class="ml-2">Email me when someone answers on my forum thread</span>
                                    </div>
                                    <div class="mb-4 flex items-center">
                                        <input type="checkbox" name="follows" class="form-checkbox h-5 w-5 text-blue-600" <%= user.notifications?.follows ? 'checked' : '' %>>
                                        <span class="ml-2">Email me when someone follows me</span>
                                    </div>
                                </div>
                                <hr class="border-gray-200 m-0">
                                <div class="p-6 pb-2">
                                    <h6 class="mb-4 font-medium">Application</h6>
                                    <div class="mb-4 flex items-center">
                                        <input type="checkbox" name="announcements" class="form-checkbox h-5 w-5 text-blue-600" <%= user.notifications?.announcements ? 'checked' : '' %>>
                                        <span class="ml-2">News and announcements</span>
                                    </div>
                                    <div class="mb-4 flex items-center">
                                        <input type="checkbox" name="productUpdates" class="form-checkbox h-5 w-5 text-blue-600" <%= user.notifications?.productUpdates ? 'checked' : '' %>>
                                        <span class="ml-2">Weekly product updates</span>
                                    </div>
                                    <div class="mb-4 flex items-center">
                                        <input type="checkbox" name="blogDigest" class="form-checkbox h-5 w-5 text-blue-600" <%= user.notifications?.blogDigest ? 'checked' : '' %>>
                                        <span class="ml-2">Weekly blog digest</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-right mt-3">
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save changes</button>
                <button type="button" class="ml-2 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
            </div>
        </form>
    </div>
    <% } %>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Tab functionality
            $('.tab-link').click(function(e) {
                e.preventDefault();
                const target = $(this).data('target');
                const tabName = target.replace('#account-', '');
                
                // Update active tab in hidden field
                $('#activeTabField').val(tabName);
                
                // UI updates
                $('.tab-link').removeClass('active text-gray-700').addClass('text-gray-600');
                $(this).addClass('active text-gray-700').removeClass('text-gray-600');
                
                $('.tab-pane').removeClass('active');
                $(target).addClass('active');
            });

            // Initialize active tab
            const initialTab = '<%= activeTab || "general" %>';
            if (initialTab) {
                $(`.tab-link[data-target="#account-${initialTab}"]`).click();
            }

            // File input change handler
            $('input[name="profilePicture"]').change(function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('.ui-w-80').attr('src', e.target.result);
                    }
                    reader.readAsDataURL(this.files[0]);
                }
            });
        });

        $(document).ready(function() {
        // Form submission handler
        $('form').submit(function(e) {
            // Validate required fields
            const requiredFields = ['firstname', 'surname', 'email'];
            let isValid = true;
            
            requiredFields.forEach(field => {
                const value = $(`[name="${field}"]`).val().trim();
                if (!value) {
                    alert(`${field} is required`);
                    isValid = false;
                    return false;
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                return false;
            }
            
            // Show loading state
            $('button[type="submit"]').html(`
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Saving...
            `).prop('disabled', true);
        });
    });
    
    // Toggle dropdown menu
    const userMenuButton = document.getElementById('user-menu-button');
    const userMenu = document.getElementById('user-menu');
    
    userMenuButton.addEventListener('click', () => {
        const expanded = userMenuButton.getAttribute('aria-expanded') === 'true';
        userMenuButton.setAttribute('aria-expanded', !expanded);
        userMenu.classList.toggle('hidden');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (event) => {
        if (!userMenuButton.contains(event.target) && !userMenu.contains(event.target)) {
            userMenuButton.setAttribute('aria-expanded', 'false');
            userMenu.classList.add('hidden');
        }
    });
    </script>
</body>
</html>